<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docker/docker-file" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Dockerfile | Avengers Handbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://avengerscodelovers.github.io/engineering-wiki/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://avengerscodelovers.github.io/engineering-wiki/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://avengerscodelovers.github.io/engineering-wiki/docs/docker/docker-file/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Dockerfile | Avengers Handbook"><meta data-rh="true" name="description" content="Một tệp Dockerfile sẽ chứa các nội dung để định nghĩa nên một Docker Image và là đầu vào chính của Docker Engine khi câu lệnh docker build ... được thực thi."><meta data-rh="true" property="og:description" content="Một tệp Dockerfile sẽ chứa các nội dung để định nghĩa nên một Docker Image và là đầu vào chính của Docker Engine khi câu lệnh docker build ... được thực thi."><link data-rh="true" rel="icon" href="/engineering-wiki/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://avengerscodelovers.github.io/engineering-wiki/docs/docker/docker-file/"><link data-rh="true" rel="alternate" href="https://avengerscodelovers.github.io/engineering-wiki/docs/docker/docker-file/" hreflang="en"><link data-rh="true" rel="alternate" href="https://avengerscodelovers.github.io/engineering-wiki/docs/docker/docker-file/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/engineering-wiki/blog/rss.xml" title="Avengers Handbook RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/engineering-wiki/blog/atom.xml" title="Avengers Handbook Atom Feed"><link rel="stylesheet" href="/engineering-wiki/assets/css/styles.0c6a6cd2.css">
<script src="/engineering-wiki/assets/js/runtime~main.250ec37c.js" defer="defer"></script>
<script src="/engineering-wiki/assets/js/main.4e178bad.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/engineering-wiki/"><div class="navbar__logo"><img src="/engineering-wiki/img/logo-avengers.png" alt="Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/engineering-wiki/img/logo-avengers.png" alt="Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Avengers Handbook</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/engineering-wiki/docs/overview/">Standards</a><a class="navbar__item navbar__link" href="/engineering-wiki/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/AvengersCodeLovers/engineering-wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/engineering-wiki/docs/overview/">Tổng quan</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/engineering-wiki/docs/category/javascript/">Javascript</a><button aria-label="Expand sidebar category &#x27;Javascript&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/engineering-wiki/docs/category/php/">PHP</a><button aria-label="Expand sidebar category &#x27;PHP&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/engineering-wiki/docs/category/ruby-on-rails/">Ruby On Rails</a><button aria-label="Expand sidebar category &#x27;Ruby On Rails&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/engineering-wiki/docs/category/performance-testing/">Performance Testing</a><button aria-label="Expand sidebar category &#x27;Performance Testing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/engineering-wiki/docs/category/docker/">Docker</a><button aria-label="Collapse sidebar category &#x27;Docker&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/engineering-wiki/docs/docker/why_docker/">Tổng quan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/engineering-wiki/docs/docker/docker-file/">Dockerfile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/engineering-wiki/docs/docker/docker-compose/">Docker Compose</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/engineering-wiki/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/engineering-wiki/docs/category/docker/"><span itemprop="name">Docker</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Dockerfile</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Dockerfile</h1>
<p>Một tệp Dockerfile sẽ chứa các nội dung để định nghĩa nên một Docker Image và là đầu vào chính của Docker Engine khi câu lệnh <code>docker build ...</code> được thực thi.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="không-được-phép-nâng-cấp-phiên-bản-của-hệ-điều-hành-bằng-câu-lệnh">Không được phép nâng cấp phiên bản của hệ điều hành bằng câu lệnh.<a href="#không-được-phép-nâng-cấp-phiên-bản-của-hệ-điều-hành-bằng-câu-lệnh" class="hash-link" aria-label="Direct link to Không được phép nâng cấp phiên bản của hệ điều hành bằng câu lệnh." title="Direct link to Không được phép nâng cấp phiên bản của hệ điều hành bằng câu lệnh.">​</a></h2>
<p><strong>CÓ THỂ</strong> &quot;cập nhật&quot; các gói phần mềm của hệ điều hành bên trong <strong>Base Image</strong>, nhưng <strong>Không Được Phép</strong> thay thế <strong>Base Image</strong> bằng việc &quot;nâng cấp&quot;&quot; bên trong Dockerfile.</p>
<p>Như này thì không sao</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu: 14.04.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apt-get update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; apt-get install -y ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nhưng như này thì không được</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu: 14.04.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apt-get update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; apt-get upgrade -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; apt-get install -y ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Câu lệnh <code>apt-get upgrade</code> (hoặc những câu lệnh nâng cấp <strong>Base Image</strong> khác tương đương) có thể làm thay đổi phiên bản của những phần mềm đã cài đặt sẵn hoặc thậm chí cài đặt hoặc xoá bỏ những gói phần mềm trên dependency mới. Kết quả là Docker Image không còn giống với <strong>Base Image</strong> nữa.</p>
<p>Nếu cần phải thay đổi điều gì khi chạy <code>docker build</code> bị lỗi, hãy <strong>CÂN NHẮC</strong> thay đổi luôn phiên bản <strong>Base Image</strong></p>
<p>FROM ubuntu: new-version</p>
<h1>...</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bên-trong-dockerfile-đừng-sử-dụng-các-phần-mềm-như-puppet-ansible-salt-">Bên trong Dockerfile, đừng sử dụng các phần mềm như puppet, ansible, salt, ...<a href="#bên-trong-dockerfile-đừng-sử-dụng-các-phần-mềm-như-puppet-ansible-salt-" class="hash-link" aria-label="Direct link to Bên trong Dockerfile, đừng sử dụng các phần mềm như puppet, ansible, salt, ..." title="Direct link to Bên trong Dockerfile, đừng sử dụng các phần mềm như puppet, ansible, salt, ...">​</a></h2>
<p>Theo như tài liệu mô tả về Dockerfile <a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="noopener noreferrer">Dockerfile reference</a> có định nghĩa như sau:</p>
<blockquote>
<p>[...] is a text document that contains <strong>all</strong> the commands a user could <strong>call on the command line</strong> to assemble an image.</p>
</blockquote>
<blockquote>
<p>[...] là một tệp tin văn bản chứa <strong>tất cả</strong> những câu lệnh mà người dùng có thể <strong>gọi trên command line</strong> để lắp ráp thành một image.</p>
</blockquote>
<p>Nếu sử dụng các công cụ quản lý cấu hình bên (configuration management tool) trong container, dù vẫn được phép nhưng có những rủi ro sau:</p>
<ol>
<li>Vô hình chung cài đặt những phần mềm và dịch vụ không cần thiết hoặc có rủi ro khi chạy (ví dụ một cơ sở dữ liệu thì không cần phải có <a href="https://www.puppet.com/" target="_blank" rel="noopener noreferrer">puppet</a>).</li>
<li>Có những bước cài đặt ngầm được thực hiện bởi bất cứ ai sở hữu Dockerfile, làm mất đi tính minh bạch của Dockerfile.</li>
<li>Hầu hết mọi ngư  ời sẽ quen với các phần mềm quản lý package như apt, apk, yum,..., thay vì các công cụ quản lý cấu hình.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chỉ-sử-dụng-những-image-được-phát-triển-từ-những-nguồn-tin-cậy">Chỉ sử dụng những image được phát triển từ những nguồn tin cậy<a href="#chỉ-sử-dụng-những-image-được-phát-triển-từ-những-nguồn-tin-cậy" class="hash-link" aria-label="Direct link to Chỉ sử dụng những image được phát triển từ những nguồn tin cậy" title="Direct link to Chỉ sử dụng những image được phát triển từ những nguồn tin cậy">​</a></h2>
<p>Việc download (pull) và sử dụng các image được dựng sẵn từ những nguồn cộng đồng khá là tiện lợi và dễ dàng.</p>
<p>Tuy nhiên, để tránh rủi ro từ những image thiếu chuẩn chỉnh hoặc bị ngừng phát triển, chúng ta chỉ nên sử dụng những Docker Image <strong>chính thức</strong> từ <strong>Docker Hub</strong> tại <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">https://hub.docker.com/</a> cho các môi trường chính (không phải môi trường thử nghiệm ).</p>
<p>Ví dụ về một Dockerfile sử dụng <strong>Docker Hub</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># official image, because there is NO account or the &quot;library&quot; account being used</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu:14.04.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># FROM library/ubuntu:14.04.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># FROM hub.docker.com/library/ubuntu:14.04.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="không-được-phép-chứa-thông-tin-bí-mật-trong-dockerfile-hoặc-repository-tương-ứng">Không được phép chứa thông tin bí mật trong Dockerfile (hoặc repository tương ứng)<a href="#không-được-phép-chứa-thông-tin-bí-mật-trong-dockerfile-hoặc-repository-tương-ứng" class="hash-link" aria-label="Direct link to Không được phép chứa thông tin bí mật trong Dockerfile (hoặc repository tương ứng)" title="Direct link to Không được phép chứa thông tin bí mật trong Dockerfile (hoặc repository tương ứng)">​</a></h2>
<p>Một ví dụ xấu của Dockerfile</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu:14.04.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MAINTAINER ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV API_KEY=4711101 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    USR=admin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PWD=the_admin_password \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CREDITCARD=5555 3333 2222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD the_same_secrets.txt /etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Bắt buộc phải giữ các thông tin bí mật (secret keys) ra khỏi Dockerfile <strong>VÀ</strong> repository tương ứng.</p>
<p>Docker repository có thể được chia sẻ công khai, và thông tin bí mật có thể bị lộ ra ngoài.
Ngay cả những private repository, việc sử dụng các thông tin bí mật trong Dockerfile cũng là một rủi ro.</p>
<p>Có thể giải quyết vấn đề bằng những cách sau:</p>
<ul>
<li>cung cấp thông tin bí mật dưới dạng <strong>biến môi trường</strong> khi khởi động container với <code>docker run -e API_KEY=4711 ...</code></li>
<li>tạo <strong>repository riêng biệt cho các container chứa thông tin bí mật</strong> mà không bao giờ bị công khai ra ngoài</li>
<li>tạo các container chỉ chứa <strong>cấu hình &quot;tạm thời&quot;</strong> trong quá trình cài đặt</li>
<li>để <strong>entrypoint hoặc command của container lấy thông tin bí mật</strong> khi khởi động.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="verify-các-artifacts-đã-download">Verify các artifacts đã download<a href="#verify-các-artifacts-đã-download" class="hash-link" aria-label="Direct link to Verify các artifacts đã download" title="Direct link to Verify các artifacts đã download">​</a></h2>
<p>Khi sử dụng Dockerfile với câu lệnh <code>docker build</code>, các tệp từ hệ thống tệp cục bộ (build context) có thể được sử dụng hoặc được lấy từ các dịch vụ trong mạng nội bộ hoặc internet.</p>
<p>Bắt buộc phải verify các tệp được download từ bên ngoài.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-các-artifacts-đã-download-i">Verify các artifacts đã download (I)<a href="#verify-các-artifacts-đã-download-i" class="hash-link" aria-label="Direct link to Verify các artifacts đã download (I)" title="Direct link to Verify các artifacts đã download (I)">​</a></h3>
<p>Có thể verify bằng một trong những cách sau:</p>
<ul>
<li>Sử dụng chữ ký ở một tệp riêng biệt</li>
<li>Sử dụng một file đã được hash và kết hợp với một file chữ ký từ public keyserver.</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENV HASHICORP_KEYIDS=51852D87348FFC4C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RUN curl -sL https://releases.hashicorp.com/vault/0.5.0/vault_0.5.0_linux_amd64.zip &gt;  vault_0.5.0_linux_amd64.zip \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; curl -sL https://releases.hashicorp.com/vault/0.5.0/vault_0.5.0_SHA256SUMS &gt; app.sha \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; curl -sL https://releases.hashicorp.com/vault/0.5.0/vault_0.5.0_SHA256SUMS.sig &gt; app.sig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; gpg --recv-keys ${HASHICORP_KEYIDS} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; gpg --verify app.sig app.sha \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; grep linux_amd64 app.sha | sha256sum -sc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; echo &quot;We only get here if sha256sum succeeded ...&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Sử dụng keyserver với giao thức HTTP (cổng 80) có thể giúp giải quyết các vấn đề với tường lửa (firewall), thay vì HTTPS.</p>
</blockquote>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENV HASHICORP_KEYIDS=51852D87348FFC4C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	RUN curl -sL https://releases.hashicorp.com/vault/0.5.0/vault_0.5.0_linux_amd64.zip &gt;  vault_0.5.0_linux_amd64.zip \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; curl -sL https://releases.hashicorp.com/vault/0.5.0/vault_0.5.0_SHA256SUMS &gt; app.sha \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; curl -sL https://releases.hashicorp.com/vault/0.5.0/vault_0.5.0_SHA256SUMS.sig &gt; app.sig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; gpg --keyserver http://pool.sks-keyservers.net:80 --recv-keys ${HASHICORP_KEYIDS} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; gpg --verify app.sig app.sha \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; grep linux_amd64 app.sha | sha256sum -sc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; echo &quot;We only get here if sha256sum succeeded ...&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-các-artifacts-đã-download-ii">Verify các artifacts đã download (II)<a href="#verify-các-artifacts-đã-download-ii" class="hash-link" aria-label="Direct link to Verify các artifacts đã download (II)" title="Direct link to Verify các artifacts đã download (II)">​</a></h3>
<p>Nếu không có lựa chọn nào tốt hơn, bạn <strong>NÊN</strong> sử dụng HASH từ một nguồn tin cậy (ví dụ như đặt trực tiếp trong Dockerfile)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ENV VAULT_SHA256=f81accce15313881b8d53b039daf090398b2204b1154f821a863438ca2e5d570</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RUN curl -sL https://releases.hashicorp.com/vault/0.5.0/vault_0.5.0_linux_amd64.zip &gt; /tmp/my_file \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; echo &quot;${VAULT_SHA256}  /tmp/my_file&quot; | sha256sum -sc  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; echo &quot;We only get here if sha256sum succeeded ...&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hạn-chế-các-tiến-trình-với-quyền-root-trong-container">Hạn chế các tiến trình với quyền &quot;root&quot; trong container<a href="#hạn-chế-các-tiến-trình-với-quyền-root-trong-container" class="hash-link" aria-label="Direct link to Hạn chế các tiến trình với quyền &quot;root&quot; trong container" title="Direct link to Hạn chế các tiến trình với quyền &quot;root&quot; trong container">​</a></h2>
<p>Một tiến trình bên trong container không nên chạy với quyền root (với uid &quot;0&quot;) để giảm thiểu rủi ro khi chạy - đặc biệt là với các volume (root-owned ?) từ host. Ngay cả Docker Engine &gt; 1.10 (với các tính năng bảo mật mới được kích hoạt) cũng là một rủi ro cần tránh.</p>
<p>Nếu có thể, hãy sử dụng một user riêng biệt để chạy các tiến trình bên trong Dockerfile.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">host$ cat dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Installing as almighty &quot;root&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># now switching to harmless &quot;guest&quot; runtime user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER guest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT [&quot;/my_entrypoint.sh&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [&quot;/my_command.sh&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Một số tiến trình - như Apache hoặc Nginx - phải được khởi động với quyền root,
nhưng thiết lập để chuyển sang một user runtime khác sẽ ít rủi ro hơn.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chỉ-expose-những-cổng-cần-thiết">Chỉ EXPOSE những cổng cần thiết<a href="#chỉ-expose-những-cổng-cần-thiết" class="hash-link" aria-label="Direct link to Chỉ EXPOSE những cổng cần thiết" title="Direct link to Chỉ EXPOSE những cổng cần thiết">​</a></h2>
<p>Trong Dockerfile, chỉ nên <code>EXPOSE</code> những cổng cần thiết ra bên ngoài container. Nếu một tiến trình cung cấp API qua cổng 80 VÀ 443, nhưng lại không cần tới cổng 80, thì điều này nên được phản ánh trong Dockerfile:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> #</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # Disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # EXPOSE 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXPOSE 443</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ghi-logerror-ra-stdoutstderr">Ghi Log/Error ra Stdout/Stderr<a href="#ghi-logerror-ra-stdoutstderr" class="hash-link" aria-label="Direct link to Ghi Log/Error ra Stdout/Stderr" title="Direct link to Ghi Log/Error ra Stdout/Stderr">​</a></h2>
<p>Docker Daemon (trình quản lý Docker) lưu hoặc chuyển tiếp dữ liệu (chuỗi văn bản) được ghi ra stdout hoặc stderr bởi tiến trình bên trong container. Container nên sử dụng chức năng này, nếu có thể, để hỗ trợ một phương thức quản lý log chuẩn chỉnh.</p>
<p>Stdout nên chứa những thông tin thông thường về hoạt động của các tiến trình, trong khi stderr nên được giới hạn với những thông báo về lỗi kỹ thuật hoặc cảnh báo mà người vận hành hoặc quản trị viên phải chú ý.</p>
<p>Những nội dung trong log nên được chuẩn hoá (ví dụ như định dạng json) để tránh việc phải phân tích nhiều bước trong quá trình xử lý sau này.</p>
<p>Đương nhiên, ứng dụng có thể sử dụng các phương tiện khác (bổ sung) để chuyển tiếp log nhưng việc ghi log ra stdout/stderr là một cách tiếp cận tức thời nhất.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sử-dụng-exec-thay-vì-shell">Sử dụng Exec thay vì Shell<a href="#sử-dụng-exec-thay-vì-shell" class="hash-link" aria-label="Direct link to Sử dụng Exec thay vì Shell" title="Direct link to Sử dụng Exec thay vì Shell">​</a></h2>
<p>Nên viết các câu lệnh <a href="https://docs.docker.com/engine/reference/builder/#cmd" target="_blank" rel="noopener noreferrer">CMD</a> và <a href="https://docs.docker.com/engine/reference/builder/#entrypoint" target="_blank" rel="noopener noreferrer">ENTRYPOINT</a> bằng cách sử dụng Exec-form.</p>
<p>Sử dụng shell form sẽ kích hoạt tới <code>/bin/sh -c</code> với câu lệnh và tham số đã chỉ định.</p>
<p>Hệ quả, khi sử dụng lệnh <code>docker stop</code> hoặc <code>docker kill</code>, tín hiệu POSIX chỉ được gửi tới tiến trình bên trong container chạy với PID 1, và nếu tiến trình đó là <code>/bin/sh</code> thì thay vì tiến trình gốc đã khởi tạo và <code>/bin/sh</code> không chuyển tiếp tín hiệu tới bất kỳ tiến trình con nào, chúng ta sẽ không thể <a href="https://web.archive.org/web/20220905230623/https://www.ctl.io/developers/blog/post/gracefully-stopping-docker-containers/" target="_blank" rel="noopener noreferrer">dừng tiến trình đúng cách</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="một-tiến-trìnhdịch-vụ-trên-mỗi-container">Một tiến trình/dịch vụ trên mỗi container<a href="#một-tiến-trìnhdịch-vụ-trên-mỗi-container" class="hash-link" aria-label="Direct link to Một tiến trình/dịch vụ trên mỗi container" title="Direct link to Một tiến trình/dịch vụ trên mỗi container">​</a></h2>
<p>Một Dockerfile chỉ nên cài đặt các phần mềm cho một service duy nhất.</p>
<p>Một service có thể là một tiến trình như web server hoặc database server.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu:14.04.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [ &quot;/opt/myservice/myprogram&quot; ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lý do cho việc này là STREAMS (Stdin/Stdout/Stderr) và SIGNAL giữa Docker Engine và
các tiến trình chạy trong Docker Container. Khi không được xây dựng/xử lý
cẩn thận, một số vấn đề tương tự như &quot;unix process zombies&quot; có thể nảy sinh ...</p>
<p>Việc chạy nhiều service cùng lúc đòi hỏi việc cài đặt và khởi động ứng dụng phải theo &quot;đúng cách&quot;</p>
<blockquote>
<p>Có những giải pháp để xử lý &quot;đúng cách&quot; nhiều tiến trình trong một container như <a href="https://docs.docker.com/engine/admin/using_supervisord/" target="_blank" rel="noopener noreferrer">Việc sử dụng Supervisor bên trong Docker</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="một-dockerfile-cho-mỗi-source-repository">Một Dockerfile cho mỗi Source Repository<a href="#một-dockerfile-cho-mỗi-source-repository" class="hash-link" aria-label="Direct link to Một Dockerfile cho mỗi Source Repository" title="Direct link to Một Dockerfile cho mỗi Source Repository">​</a></h2>
<p>Khi có nhiều Dockerfile trong một repository, việc theo dõi các thay đổi và xây dựng Dockerimage sẽ trở nên phức tạp.</p>
<p>Đối với các tool CI/CD, autobuilds (gocd, jenkins, ...), việc theo dõi các thay đổi của một repository cho <strong>một</strong> Dockerimage và các phần mềm liên quan là rất quan trọng.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sử-dụng-chế-độ-interactive-để-kiểm-tra-các-câu-lệnh">Sử dụng chế độ <code>interactive</code> để kiểm tra các câu lệnh<a href="#sử-dụng-chế-độ-interactive-để-kiểm-tra-các-câu-lệnh" class="hash-link" aria-label="Direct link to sử-dụng-chế-độ-interactive-để-kiểm-tra-các-câu-lệnh" title="Direct link to sử-dụng-chế-độ-interactive-để-kiểm-tra-các-câu-lệnh">​</a></h2>
<p>Ví dụ, có thể viết Dockerfile như sau</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu:14.04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN curl -sL https://github.com/hlgr360/docker-templates/archive/master.zip \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -o /tmp/master.zip</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>và sau đó kiểm tra nó ...</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker build .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sending build context to Docker daemon 2.048 kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 1 : FROM ubuntu:14.04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; 14b59d36bae0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2 : RUN curl -sL https://github.com/hlgr360/docker-templates/archive/master.zip   -o /tmp/master.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; Running in 5c9deb4eb14a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/bin/sh: 1: curl: not found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The command &#x27;/bin/sh -c curl -sL https://github.com/hlgr360/docker-templates/archive/master.zip   -o /tmp/master.zip&#x27; returned a non-zero code: 127</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>chỉnh sửa Dockerfile, kiểm tra lại ...</p>
<p>Lặp lại các bước trên sẽ tốn thời gian.</p>
<p>Việc sử dụng chế độ <code>interactive</code> sẽ giúp dễ dàng kiểm tra các câu lệnh và kiểm tra xem chúng có hoạt động hay không, trước khi build, giảm thời gian xây dựng Dockerfile.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run -it [image] [command-or-shell]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -it ubuntu:14.04 /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@10f5608e9db3:/# curl -sL  https://github.com/hlgr360/docker-templates/archive/master.zip   -o /tmp/master.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bash: curl: command not found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@10f5608e9db3:/# apt-get update &amp;&amp; apt-get install -y curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ign http://archive.ubuntu.com trusty InRelease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Get:1 http://archive.ubuntu.com trusty-updates InRelease [65.9 kB]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting up curl (7.35.0-1ubuntu2.6) ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing triggers for libc-bin (2.19-0ubuntu6.7) ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing triggers for ca-certificates (20160104ubuntu0.14.04.1) ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Updating certificates in /etc/ssl/certs... 173 added, 0 removed; done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running hooks in /etc/ca-certificates/update.d....done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@10f5608e9db3:/# curl -sL  https://github.com/hlgr360/docker-templates/archive/master.zip   -o /tmp/master.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@10f5608e9db3:/#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="giảm-số-lượng-layer">Giảm số lượng layer<a href="#giảm-số-lượng-layer" class="hash-link" aria-label="Direct link to Giảm số lượng layer" title="Direct link to Giảm số lượng layer">​</a></h2>
<p>Hầu hết các câu lệnh trong Dockerfile tạo ra các layer bổ sung cho Dockerimage trong quá trình chạy <code>docker build</code>. Nếu nối các câu lệnh đó, image có thể được tối ưu hóa lại:</p>
<p>Thay vì</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM debian:wheezy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV TEST1 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV TEST2 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN wget -nv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN tar -xvf someutility-v1.0.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mv /tmp/someutility-v1.0.0/someutil /usr/bin/someutil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN rm -rf /tmp/someutility-v1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN rm /tmp/someutility-v1.0.0.tar.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nên nối lại các câu lệnh</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM debian:wheezy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV TEST1=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TEST2=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN wget -nv &amp;&amp; tar -xvf someutility-v1.0.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &amp;&amp; mv /tmp/someutility-v1.0.0/someutil /usr/bin/someutil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &amp;&amp; rm -rf /tmp/someutility-v1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &amp;&amp; rm /tmp/someutility-v1.0.0.tar.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Kết quả là image có ít layer hơn và do đó chiếm ít không gian lưu trữ hơn so với ví dụ đầu tiên.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ưu-tiên-cài-đặt-các-phần-mềm-trước">Ưu tiên cài đặt các phần mềm trước<a href="#ưu-tiên-cài-đặt-các-phần-mềm-trước" class="hash-link" aria-label="Direct link to Ưu tiên cài đặt các phần mềm trước" title="Direct link to Ưu tiên cài đặt các phần mềm trước">​</a></h2>
<p>Các câu lệnh chạy lâu dài nên được đặt trước, để cache build có thể hiệu quả.</p>
<p>Ví dụ sau là chưa ổn - vì bất kỳ thay đổi nào trong các tệp trong thư mục <code>./root</code> sẽ xoá bỏ cache build và kích hoạt lại câu lệnh <code>apk --update...</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Add changed files from context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD root /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Update package information, install packages and clear package cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apk --update add curl ca-certificates gnupg jq \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;&amp; rm -rf /var/cache/apk/* </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cải thiện hơn như sau - vì khả năng cao, kết quả cache của <code>apk --update...</code> sẽ không thay đổi trong thời gian sắp tới. Thay đổi trong các tệp trong thư mục <code>./root</code> chỉ dẫn đến một layer mới cho các tệp tin đã thay đổi.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Update package information, install packages and clear package cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apk --update add curl ca-certificates gnupg jq \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;&amp; rm -rf /var/cache/apk/* </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add changed files from context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD root /</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="đừng-sử-dụng-add-với-url">Đừng sử dụng ADD với URL<a href="#đừng-sử-dụng-add-với-url" class="hash-link" aria-label="Direct link to Đừng sử dụng ADD với URL" title="Direct link to Đừng sử dụng ADD với URL">​</a></h2>
<p>Ví dụ câu lệnh sau đã vô hiệu hóa cache của các câu lệnh Docker tiếp theo.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ADD https://.../filename /tmp/filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># not using cache anymore :-(</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Tốt hơn hãy sử dụng curl hoặc wget (bất kể phần mềm nào có sẵn)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RUN curl -L https://.../filename &gt; /tmp/filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># caching still in effect :-)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="thêm-nhiều-tệp-tin-thông-qua-thư-mục-có-cấu-trúc">Thêm (nhiều) tệp tin thông qua thư mục có cấu trúc<a href="#thêm-nhiều-tệp-tin-thông-qua-thư-mục-có-cấu-trúc" class="hash-link" aria-label="Direct link to Thêm (nhiều) tệp tin thông qua thư mục có cấu trúc" title="Direct link to Thêm (nhiều) tệp tin thông qua thư mục có cấu trúc">​</a></h2>
<p>Thông thường, sẽ thêm các tệp tin bằng câu lệnh ADD như sau</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ADD file1.txt /some/path1/file1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD file2.txt /some/path2/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD file3.txt /some/other/path3/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cùng kết quả có thể đạt được (dễ dàng hơn) bằng cách sử dụng một cấu trúc thư mục con có sẵn trong build-context. Ví dụ về danh sách tệp</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">host$ find .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./root/etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./root/etc/vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./root/etc/vault/vault.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./root/entrypoint.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">host$ cat Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add all files from a directory structure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD root /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The image now contains /etc/vault/vault.json AND /entrypoint.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="thiết-lập-quyền-truy-cập-cho-tệp-tin-bên-ngoài-dockerfile-đúng-cách">Thiết lập quyền truy cập cho tệp tin bên ngoài Dockerfile đúng cách<a href="#thiết-lập-quyền-truy-cập-cho-tệp-tin-bên-ngoài-dockerfile-đúng-cách" class="hash-link" aria-label="Direct link to Thiết lập quyền truy cập cho tệp tin bên ngoài Dockerfile đúng cách" title="Direct link to Thiết lập quyền truy cập cho tệp tin bên ngoài Dockerfile đúng cách">​</a></h2>
<p>Làm như sau là không tốt, vì nó tốn thời gian và tạo ra một layer mới:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">host$ cat Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creates one layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD entrypoint.sh /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creates another layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN chmod +x /entrypoint.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Như này thì ổn hơn:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">host$ chmod +x entrypoint.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">host$ cat Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creates one layer and preserves the (already set) execution flag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD entrypoint.sh /</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="entrypoint-vs-cmd">Entrypoint vs CMD<a href="#entrypoint-vs-cmd" class="hash-link" aria-label="Direct link to Entrypoint vs CMD" title="Direct link to Entrypoint vs CMD">​</a></h2>
<p>Nên sử dụng Entrypoint để chỉ định chương trình mặc định sẽ được gọi khi container được khởi động và các đối số mặc định mà có khả năng dễ bị thay đổi nên được cung cấp thông qua CMD.</p>
<p>Có thể tìm hiểu sâu hơn <a href="https://web.archive.org/web/20220318023927/https://www.ctl.io/developers/blog/post/dockerfile-entrypoint-vs-cmd/" target="_blank" rel="noopener noreferrer">ở đây</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/AvengersCodeLovers/engineering-wiki/tree/main/docs/docker/docker-file.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/engineering-wiki/docs/docker/why_docker/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Tổng quan</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/engineering-wiki/docs/docker/docker-compose/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Docker Compose</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#không-được-phép-nâng-cấp-phiên-bản-của-hệ-điều-hành-bằng-câu-lệnh" class="table-of-contents__link toc-highlight">Không được phép nâng cấp phiên bản của hệ điều hành bằng câu lệnh.</a></li><li><a href="#bên-trong-dockerfile-đừng-sử-dụng-các-phần-mềm-như-puppet-ansible-salt-" class="table-of-contents__link toc-highlight">Bên trong Dockerfile, đừng sử dụng các phần mềm như puppet, ansible, salt, ...</a></li><li><a href="#chỉ-sử-dụng-những-image-được-phát-triển-từ-những-nguồn-tin-cậy" class="table-of-contents__link toc-highlight">Chỉ sử dụng những image được phát triển từ những nguồn tin cậy</a></li><li><a href="#không-được-phép-chứa-thông-tin-bí-mật-trong-dockerfile-hoặc-repository-tương-ứng" class="table-of-contents__link toc-highlight">Không được phép chứa thông tin bí mật trong Dockerfile (hoặc repository tương ứng)</a></li><li><a href="#verify-các-artifacts-đã-download" class="table-of-contents__link toc-highlight">Verify các artifacts đã download</a><ul><li><a href="#verify-các-artifacts-đã-download-i" class="table-of-contents__link toc-highlight">Verify các artifacts đã download (I)</a></li><li><a href="#verify-các-artifacts-đã-download-ii" class="table-of-contents__link toc-highlight">Verify các artifacts đã download (II)</a></li></ul></li><li><a href="#hạn-chế-các-tiến-trình-với-quyền-root-trong-container" class="table-of-contents__link toc-highlight">Hạn chế các tiến trình với quyền &quot;root&quot; trong container</a></li><li><a href="#chỉ-expose-những-cổng-cần-thiết" class="table-of-contents__link toc-highlight">Chỉ EXPOSE những cổng cần thiết</a></li><li><a href="#ghi-logerror-ra-stdoutstderr" class="table-of-contents__link toc-highlight">Ghi Log/Error ra Stdout/Stderr</a></li><li><a href="#sử-dụng-exec-thay-vì-shell" class="table-of-contents__link toc-highlight">Sử dụng Exec thay vì Shell</a></li><li><a href="#một-tiến-trìnhdịch-vụ-trên-mỗi-container" class="table-of-contents__link toc-highlight">Một tiến trình/dịch vụ trên mỗi container</a></li><li><a href="#một-dockerfile-cho-mỗi-source-repository" class="table-of-contents__link toc-highlight">Một Dockerfile cho mỗi Source Repository</a></li><li><a href="#sử-dụng-chế-độ-interactive-để-kiểm-tra-các-câu-lệnh" class="table-of-contents__link toc-highlight">Sử dụng chế độ <code>interactive</code> để kiểm tra các câu lệnh</a></li><li><a href="#giảm-số-lượng-layer" class="table-of-contents__link toc-highlight">Giảm số lượng layer</a></li><li><a href="#ưu-tiên-cài-đặt-các-phần-mềm-trước" class="table-of-contents__link toc-highlight">Ưu tiên cài đặt các phần mềm trước</a></li><li><a href="#đừng-sử-dụng-add-với-url" class="table-of-contents__link toc-highlight">Đừng sử dụng ADD với URL</a></li><li><a href="#thêm-nhiều-tệp-tin-thông-qua-thư-mục-có-cấu-trúc" class="table-of-contents__link toc-highlight">Thêm (nhiều) tệp tin thông qua thư mục có cấu trúc</a></li><li><a href="#thiết-lập-quyền-truy-cập-cho-t ệp-tin-bên-ngoài-dockerfile-đúng-cách" class="table-of-contents__link toc-highlight">Thiết lập quyền truy cập cho tệp tin bên ngoài Dockerfile đúng cách</a></li><li><a href="#entrypoint-vs-cmd" class="table-of-contents__link toc-highlight">Entrypoint vs CMD</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/engineering-wiki/docs/overview/">Standards</a></li><li class="footer__item"><a href="https://tutorial.docusaurus.io/docs/category/tutorial---basics" target="_blank" rel="noopener noreferrer" class="footer__link-item">How to write docs?</a></li></ul></div><div class="col footer__col"><div class="footer__title">Services</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://avengers.sun-asterisk.vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">aPortal<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://sal.vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">SAL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/engineering-wiki/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/AvengersCodeLovers/engineering-wiki" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Avengers Code Lovers. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>